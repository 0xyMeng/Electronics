---
sort: 5
---
# 输出输入控制

## 输入输出控制
（数据）输入输出对计算机来讲是必可不少的。由于外设速度各不相同，因此CPU与外设之间传输数据的三种控制方式有：程序方式、中断方式、DMA方式。
## 程序传送方式
程序方式根据程序控制的方法分为无条件传送和条件传送（查询方式）。无条件传送方式的前提是外设必须随时准备就绪，适用于简单设备如数码管、按键、拨码开关等。条件传送有查询环节和传送环节，对应状态端口和数据端口
无条件传送
一个例子，输入输出地址相同，通过读写信号区分。
 
条件传送输入
①输入ready信号；②查询端口查询DB上的状态信号；③如果数据准备好，选通数据端口，数据送上数据总线，同时D触发器复位。
 
上面这个设计很精妙，状态和数据都送上数据总线，在读数据的时候同时用这个信号复位了状态标志锁存器。
条件传送输出接口
①查询状态端口；②若空闲，数据送上数据锁存器；③外设取走数据ACK复位。
 
这个接口分析的时候先从数据送上总线开始分析，送上总线同时通过D触发器通知输出设备数据就位，同时信号也回到状态端口，设备取走数据后触发器复位。
条件传送的优先级
大系统设备较多时，可以用轮流查询的方式来分配优先级，先查询的设备有较高的优先级。这是一种程序控制优先级的方式。
## 中断传送方式
中断传送方式介绍
中断需要CPU功能上的配合，因此在x86指令集中有和中断相关的指令。
中断过程：(1)中断请求；(2)中断响应；(3)关中断；(4)断点保护；(5)中断源识别；(6)现场保护；(7)中断服务；(8)恢复现场；(9)开中断；(10)中断返回。
8086CPU中断检测：每条指令的最后一个时钟周期采样中断请求输入引脚。
 
一个中断接口如图，输入设备送数据发出中断信号，应答时选通中断向量寄存器，读数据同时复位中断信号。
中断优先权的判定方法：软件查询、简单硬件电路、专用硬件。
8086CPU中断操作
8086/8088系统中，中断分为硬件中断和软件中断。硬件中断又可分为可屏蔽中断（INTR）和不可屏蔽中断（NMI）。（IF=1响应可屏蔽中断）。软件中断由运算或中断指令 INT n 产生。
中断向量：中断服务子程序的入口地址；
中断向量表：所有的中断向量按照一定的规律排列存放到0000H-03FFH；
向量号为N的物理地址为N*4，CPU响应中断获取中断号后就可以找到中断服务程序的入口地址。每个中断向量4Byte，CS:IP，地址低位存放。8086的中断类型码为0~255，256个中断占用1KB空间。
 
INTR信号是一个电平信号，并且要维持2个时钟周期。CPU在每一条指令的最后一个时钟周期T采样INTR。
中断向量表的建立方法：绝对地址置入、DOS调用法。
 
 
★中断响应的优先级：当前指令>软件中断>非屏蔽中断>可屏蔽中断>单步中断>下条指令。
可编程中断控制器8259A
一片8259A可以管理8级中断。最多可以用9片8259A来构成64级的主从式中断管理系统。
	编程结构和引脚
    
CAS0-CAS2：级联信号。主片输出，从片输入。
¯("SP" ) "/" ¯("EN" )：从设备编程/允许缓冲器。作输入信号使用时，为SP主片/从片的选择控制信号。
A0=0时，对应ICW1， OCW2和OCW3；
A0=1时，对应ICW2，ICW3，ICW4和OCW1。
中断请求寄存器IRR：接收IR0-IR7中断请求，并按中断请求的方式在IRR的相应位置位。
当前服务寄存器ISR：存放当前正在处理的中断请求。相应位的置位来实现。ISR的置位是在中断响应的第一个INTA有效时完成的。
中断屏蔽寄存器IMR：置位屏蔽。
	工作方式
普通全嵌套：中断优先权顺序固定不变，从高到低依次为IR0，IR1，IR2，…，IR7。
特殊全嵌套：只有主片可以设置为特殊全嵌套，允许主片同级中断的嵌套，用于级联。
优先权自动循环方式：一个中断得到响应后，它的优先权自动降为最低。
优先权特殊循环方式：初始最低优先权是由编程确定。
自动中断结束方式：一进入中断过程，自动将中断服务寄存器中的对应位清除。
普通中断结束方式： 
特殊中断结束方式：级连系统的从片在一个中断服务程序结束时，都必须发两次中断结束命令。
普通屏蔽方式：IMR的Di位置1，则对应的中断IRi就被屏蔽。
特殊屏蔽方式：将IMR的Di位置1，就会同时使ISR的Di位置0。
边沿触发方式：上升沿作为中断请求信号。
电平触发方式：高电平是有效的中断请求信号。
缓冲方式：SP/EN 引脚作为输出端，输出允许信号，用以锁存或开启缓冲器。
非缓冲方式：SP/EN 引脚为输入端，级连由其确定是主片或从片。
 
	初始化编程
开始工作前，必须进行初始化编程。也就是给8259A写入初始化命令字（ICW）。
工作期间，可以通过写入操作命令字（OCW）将选定的操作传送给8259A。
ICW1~ICW4必须按顺序写入，ICW1和ICW2必须写入，ICW3和ICW4是由工作方式决定。通过A0和特征位D4D3区分ICW1、ICW2、ICW3、ICW4还是OCW1
 
①ICW1初始化字（A0=0）
 
D4：1写入的是ICW1。0写入的是OCW2，OCW3
D3：LTIM中断触发方式。0边沿触发，1电平触发 
D2：ADI调用地址间隔。8086/8088系统中无意义
D1：SNGL单片/级联。1单片方式无需ICW3，0级联方式需要ICW3
D0：IC4是否写入ICW4。1写入ICW4，0不写入ICW4
②ICW2中断向量字（A0=1）
 
用于设置中断向量号，只有D7-D3编程决定，D2-D0由中断引脚确定。
③ICW3级联命令字（A0=1）
 
★主片：接从片的引脚对应位为是1
★从片：D2-D0指明该从片接到主片的哪一个引脚
④ICW4中断方式字（A0=1）
 
D4：SFNM优先权。1特殊全嵌套，0普通全嵌套。
D3：BUF缓冲方式。1缓冲方式，0非缓冲方式
D2：M/S主片/从片。1主片，0从片（非缓冲方式无效，用SP=0确定从片）
D1：AEOI。1自动中断结束，0非自动中断结束。
D0：μPM。1 8086/8088CPU，0
	中断操作编程
8259A工作期间，可以随时接受操作命令字OCW1~OCW3，写入没有顺序要求，但应注意写入的端口地址和特征位。
OCW1屏蔽命令字（A0=1）
 
1禁止中断，0允许中断
OCW2中断结束和优先权循环命令字（A0=0）
 
R（循环），SL（设置优先权）和 EOI（中断结束）3位配合使用时，用以产生中断结束EOI命令和改变优先权顺序。
L2-L0的3位编码指定IR引脚, 只有SL=1时才有效。
OCW3屏蔽和读状态命令字（A0=0）
 
ESMM和SMM两位用于设置中断屏蔽方式。P，RR和RIS用于规定随后读取的状态字含义。
ESMM：允许设定屏蔽方式。
SMM： 屏蔽方式位。0普通屏蔽， 1特殊屏蔽。
P：1读中断查询字
无论何时读8259A的奇地址端口，读取中断屏蔽寄存器 IMR的内容
 
【例】一片8259A的端口地址为80H，查询中断请求状态字、IRR、ISR与IMR
## DMA传送方式
DMA方式介绍
适用于高速外设及大量数据块传输的场合
DMA传送工作过程：①DMA初始化设置（工作方式，缓冲区首址，字节数）；②总线让出；③数据传送；④自动增减地址计数判断完成。
DMA与CPU的两个确认信号：HOLD与HOLDA。
DMA传送的实现方式：CPU停机方式、周期挪用方式、周期扩展方式。
可编程DMA控制器8237A
4个独立的DMA传输通道，每个通道独立的地址寄存器和字节计数器，每次传送最大数据块长度64KB
4种工作模式：单字节传输、数据块传输、请求传输、级联模式。
可用5片扩展16个DMA传输通道
